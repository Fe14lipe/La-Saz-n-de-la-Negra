@{
    ViewData["Title"] = "Cuponera Anual";
    var feriados = ViewBag.Feriados as List<WEBAPPmesaGo.Services.Feriado>;
    bool esFeriadoHoy = ViewBag.EsFeriado;
    int anioActual = DateTime.Now.Year;
}

<style>
    /* Diseño de tarjetas de mes */
    .month-card {
        background: white;
        border-radius: 12px;
        border: 1px solid #eee;
        padding: 15px;
        height: 100%;
        transition: transform 0.2s;
    }

        .month-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            border-color: var(--color-primary);
        }

    .month-title {
        font-weight: 800;
        text-align: center;
        color: #333;
        margin-bottom: 15px;
        text-transform: uppercase;
        font-size: 0.9rem;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }

    /* Grilla del calendario pequeño */
    .calendar-grid-mini {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        text-align: center;
        font-size: 0.75rem;
    }

    .day-label {
        font-weight: bold;
        color: #aaa;
        font-size: 0.65rem;
    }

    .day-cell {
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        color: #555;
        background-color: #fff;
    }

    /* Feriados */
    .day-feriado {
        background-color: var(--color-primary) !important;
        color: white !important;
        font-weight: bold;
        cursor: help; /* Cursor de ayuda para indicar que hay info */
    }

    /* Cupones */
    .special-coupon-box {
        border: 2px dashed #e0e0e0;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        background-color: #fafafa;
        position: relative;
        margin-bottom: 40px;
    }

    .coupon-active {
        border-color: var(--color-primary);
        background-color: #fff5eb;
    }

    .coupon-code {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 1.5rem;
        letter-spacing: 3px;
        color: #aaa;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        background: white;
        display: inline-block;
        margin-top: 10px;
    }

    .coupon-active .coupon-code {
        color: var(--color-primary);
        border-color: var(--color-primary);
    }
</style>

<div class="container mt-4 mb-5">
    <div class="menu-tabs mb-4 text-center">
        <a asp-controller="Portal" asp-action="Menu" class="menu-tab-item text-decoration-none text-muted">NUESTRO MENÚ</a>
        <a asp-controller="Portal" asp-action="Reservar" class="menu-tab-item text-decoration-none text-muted">RESERVAS</a>
        <span class="menu-tab-item active" style="border-bottom: 4px solid var(--color-primary);">CUPONES</span>
    </div>
    <h5 class="fw-bold mb-3 text-dark"><i class="fa-solid fa-umbrella-beach text-primary me-2"></i> CUPON DE FERIADOS</h5>

    <div class="special-coupon-box @(esFeriadoHoy ? "coupon-active" : "")">
        @if (esFeriadoHoy)
        {
            <div class="position-absolute top-0 end-0 m-3 text-success fw-bold"><i class="fa-solid fa-check-circle"></i> ACTIVO HOY</div>
            <h3 class="fw-bold text-uppercase mb-1">FERIADOS LOCOS</h3>
            <p class="text-muted mb-3">¡Hoy es feriado! Disfruta envío gratis.</p>
            <div class="coupon-code">FERIADOGO</div>
            <div class="mt-3">
                <button class="btn btn-primary rounded-pill px-4 fw-bold" onclick="canjearCupon('FERIADOGO')">USAR AHORA</button>
            </div>
        }
        else
        {
            <div class="opacity-50">
                <h3 class="fw-bold text-uppercase mb-1">FERIADOS LOCOS</h3>
                <p class="text-muted mb-0">Este cupón solo se activa en días feriados (ver calendario abajo).</p>
            </div>
        }
    </div>

    <h5 class="fw-bold mb-3 mt-5 text-dark"><i class="fa-solid fa-store text-primary me-2"></i> PARA CONSUMIR</h5>

    <div class="row g-4">
        @if (ViewBag.CuponesActivos != null)
        {
            var cupones = ViewBag.CuponesActivos as IEnumerable<WEBAPPmesaGo.Models.Cupon>;
            foreach (var cupon in cupones)
            {
                // Estilo Feriado (Naranja) vs Normal (Blanco)
                var isHoliday = cupon.EsFeriado;
                var cardClass = isHoliday ? "card h-100 border-0 shadow-sm p-3 holiday-coupon" : "card h-100 border-0 shadow-sm p-3";
                var btnClass = isHoliday ? "btn btn-outline-light fw-bold w-100 mt-2" : "btn btn-outline-primary fw-bold w-100 mt-2";
                
                <div class="col-md-4">
                    <div class="@cardClass">
                        <div class="d-flex justify-content-between mb-2">
                             <h6 class="fw-bold m-0 text-uppercase @(isHoliday ? "text-white" : "text-dark")">@cupon.Codigo</h6>
                             <i class="fa-solid fa-ticket text-muted opacity-25 @(isHoliday ? "text-white" : "")"></i>
                        </div>
                        <p class="small flex-grow-1 @(isHoliday ? "text-white" : "text-muted")">@cupon.Descripcion</p>
                        <button class="@btnClass" onclick="canjearCupon('@cupon.Codigo')">CANJEAR</button>
                    </div>
                </div>
            }
        }
    </div>

    <hr class="my-5" />

    <h2 class="text-center fw-bold mb-4" style="font-family: 'Arial Black';">CALENDARIO DE FERIADOS <span class="text-primary">@anioActual</span></h2>
    <p class="text-center text-muted mb-5">Los días marcados en naranja tienen delivery gratis.</p>

    <div class="row g-4 mb-5">
        @for (int mes = 1; mes <= 12; mes++)
        {
            var primerDia = new DateTime(anioActual, mes, 1);
            var diasEnMes = DateTime.DaysInMonth(anioActual, mes);
            int diaSemanaInicio = (int)primerDia.DayOfWeek; // 0=Domingo

            <div class="col-md-6 col-lg-4 col-xl-3">
                <div class="month-card">
                    <div class="month-title">@primerDia.ToString("MMMM").ToUpper()</div>

                    <div class="calendar-grid-mini">
                        <div class="day-label">D</div><div class="day-label">L</div><div class="day-label">M</div>
                        <div class="day-label">M</div><div class="day-label">J</div><div class="day-label">V</div>
                        <div class="day-label">S</div>

                        @for (int i = 0; i < diaSemanaInicio; i++)
                        {
                            <div></div>
                        }

                        @for (int dia = 1; dia <= diasEnMes; dia++)
                        {
                            DateTime fechaDia = new DateTime(anioActual, mes, dia);
                            // Buscamos si hay feriado este día exacto
                            var feriadoEncontrado = feriados?.FirstOrDefault(f => f.Date.Date == fechaDia.Date);
                            bool esFeriado = feriadoEncontrado != null;

                            <div class="day-cell @(esFeriado ? "day-feriado" : "")"
                                 title="@(esFeriado? feriadoEncontrado.LocalName: "")"
                                 data-bs-toggle="tooltip">
                                @dia
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function canjearCupon(codigo) {
        Swal.fire({
            title: '¡Cupón Activado!',
            text: 'Has seleccionado el código: ' + codigo + '. Inicia sesión para aplicarlo en tu reserva.',
            icon: 'success',
            confirmButtonColor: '#FF6600',
            confirmButtonText: 'IR A RESERVAR'
        }).then((result) => {
            if (result.isConfirmed) {
                // REDIRECCIÓN AUTOMÁTICA AL LOGIN/RESERVAS
                window.location.href = '@Url.Action("Reservar", "Portal")?cupon=' + codigo;
            }
        });
    }
</script>